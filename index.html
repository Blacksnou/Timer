<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO -->
    <title>Timer - Temporizador de Intervalos Online Gratis</title>
    <meta name="description" content="Timer online gratis con loop perpetuo. Temporizador de intervalos para entrenamientos, estudio y productividad. Funciona en cualquier dispositivo.">
    <meta name="keywords" content="timer, temporizador, cron√≥metro, intervalo, HIIT, pomodoro, online, gratis">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Timer - Temporizador Online">
    <meta property="og:description" content="Timer online gratis con loop perpetuo">
    <meta property="og:type" content="website">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚è≥</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .tech-bg {
            background: #0a0a0a;
            position: relative;
            overflow: hidden;
        }
        
        .floating-rect {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none;
            border-radius: 8px;
        }
        
        .floating-dot {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .glass-dark {
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .minimal-glow {
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.03);
        }
        
        .tech-border {
            position: relative;
        }
        
        .tech-border::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
        }
        
        .tech-border::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
        }
        
        .grid-pattern {
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const PlayIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
            </svg>
        );

        const PauseIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
        );

        const RotateCcwIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
        );

        function TechTimer() {
            // Cargar configuraci√≥n guardada o usar valores por defecto
            const [workTime, setWorkTime] = useState(() => {
                const saved = localStorage.getItem('timerDuration');
                return saved ? parseInt(saved) : 20;
            });
            const [currentRound, setCurrentRound] = useState(1);
            const [timeLeft, setTimeLeft] = useState(() => {
                const saved = localStorage.getItem('timerDuration');
                return saved ? parseInt(saved) : 20;
            });
            const [isRunning, setIsRunning] = useState(false);
            const [totalWorkTime, setTotalWorkTime] = useState(0);
            const [elapsedTime, setElapsedTime] = useState(0);

            const audioContextRef = useRef(null);
            const startTimeRef = useRef(null);
            const lastUpdateRef = useRef(Date.now());

            // Actualizar t√≠tulo de la pesta√±a con el tiempo
            useEffect(() => {
                document.title = `${formatTime(timeLeft)} - Timer`;
            }, [timeLeft]);

            // Sistema h√≠brido: setInterval + verificaci√≥n de tiempo real
            useEffect(() => {
                let interval;

                if (isRunning) {
                    // Guardar momento de inicio
                    if (!startTimeRef.current) {
                        startTimeRef.current = Date.now() - ((workTime - timeLeft) * 1000);
                    }

                    interval = setInterval(() => {
                        const now = Date.now();
                        const totalElapsed = Math.floor((now - startTimeRef.current) / 1000);
                        const remaining = workTime - totalElapsed;

                        if (remaining <= 0) {
                            // Timer completado
                            createBeep();
                            setTotalWorkTime(t => t + workTime);
                            setCurrentRound(r => r + 1);
                            setTimeLeft(workTime);
                            setElapsedTime(prev => prev + workTime);
                            startTimeRef.current = Date.now(); // Nuevo ciclo
                        } else {
                            setTimeLeft(remaining);
                            setElapsedTime(totalElapsed);
                        }

                        lastUpdateRef.current = now;
                    }, 250); // Actualizar cada 250ms para m√°s precisi√≥n
                }

                return () => {
                    if (interval) clearInterval(interval);
                };
            }, [isRunning, workTime]);

            // Detectar cuando la pesta√±a vuelve a estar activa
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (!document.hidden && isRunning && startTimeRef.current) {
                        // Forzar actualizaci√≥n inmediata al volver
                        const now = Date.now();
                        const totalElapsed = Math.floor((now - startTimeRef.current) / 1000);
                        const remaining = workTime - totalElapsed;
                        
                        if (remaining > 0) {
                            setTimeLeft(remaining);
                            setElapsedTime(totalElapsed);
                        }
                    }
                };

                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, [isRunning, workTime]);

            // Guardar duraci√≥n cuando cambie
            useEffect(() => {
                localStorage.setItem('timerDuration', workTime.toString());
            }, [workTime]);

            const createBeep = () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const ctx = audioContextRef.current;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.15);
            };

            const toggleTimer = () => {
                if (!isRunning) {
                    // Al iniciar, establecer tiempo de inicio
                    startTimeRef.current = Date.now() - ((workTime - timeLeft) * 1000);
                } else {
                    // Al pausar, resetear referencia
                    startTimeRef.current = null;
                }
                setIsRunning(!isRunning);
            };

            const resetTimer = () => {
                setIsRunning(false);
                setCurrentRound(1);
                setTimeLeft(workTime);
                setTotalWorkTime(0);
                setElapsedTime(0);
                startTimeRef.current = null;
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            };

            const progress = ((workTime - timeLeft) / workTime) * 100;

            // Generate FIXED positions for floating elements (usando useMemo para que no cambien)
            const floatingElements = React.useMemo(() => 
                Array.from({ length: 25 }, (_, i) => ({
                    id: i,
                    left: `${Math.random() * 100}%`,
                    top: `${Math.random() * 100}%`,
                    width: `${50 + Math.random() * 150}px`,
                    height: `${50 + Math.random() * 150}px`
                })), []
            );

            const floatingDots = React.useMemo(() =>
                Array.from({ length: 40 }, (_, i) => ({
                    id: i,
                    left: `${Math.random() * 100}%`,
                    top: `${Math.random() * 100}%`
                })), []
            );

            return (
                <div className="min-h-screen tech-bg grid-pattern flex items-center justify-center p-6 relative">
                    {/* Floating rectangles */}
                    {floatingElements.map(el => (
                        <div
                            key={`rect-${el.id}`}
                            className="floating-rect"
                            style={{
                                left: el.left,
                                top: el.top,
                                width: el.width,
                                height: el.height
                            }}
                        />
                    ))}

                    {/* Floating dots */}
                    {floatingDots.map(dot => (
                        <div
                            key={`dot-${dot.id}`}
                            className="floating-dot"
                            style={{
                                left: dot.left,
                                top: dot.top
                            }}
                        />
                    ))}

                    <div className="w-full max-w-lg relative z-10">
                        {/* Main Card */}
                        <div className="glass-dark rounded-2xl p-12 minimal-glow">
                            {/* Timer Display */}
                            <div className="text-center mb-10 tech-border pb-10 rounded-xl">
                                <div className="text-8xl font-light text-white mb-3 tracking-tight">
                                    {formatTime(timeLeft)}
                                </div>
                                <div className="text-xs text-gray-600 tracking-[0.4em] font-light">
                                    ROUND {String(currentRound).padStart(3, '0')}
                                </div>
                            </div>

                            {/* Progress Bar */}
                            <div className="mb-10 rounded-full">
                                <div className="h-[1px] bg-white/5 relative">
                                    <div 
                                        className="absolute top-0 left-0 h-full bg-white/30 transition-all duration-1000"
                                        style={{ width: `${progress}%` }}
                                    />
                                    {/* Progress indicator dot */}
                                    <div 
                                        className="absolute top-1/2 -translate-y-1/2 w-1 h-1 bg-white rounded-full"
                                        style={{ left: `${progress}%`, boxShadow: '0 0 8px rgba(255,255,255,0.5)' }}
                                    />
                                </div>
                            </div>

                            {/* Stats */}
                            <div className="grid grid-cols-2 gap-8 mb-10">
                                <div className="border-l border-white/10 pl-4 rounded-l-lg">
                                    <div className="text-xs text-gray-600 mb-2 tracking-wider">
                                        TOTAL
                                    </div>
                                    <div className="text-2xl font-light text-white">
                                        {formatTime(totalWorkTime)}
                                    </div>
                                </div>
                                <div className="border-l border-white/10 pl-4 rounded-l-lg">
                                    <div className="text-xs text-gray-600 mb-2 tracking-wider">
                                        ACTUAL
                                    </div>
                                    <div className="text-2xl font-light text-white">
                                        {formatTime(elapsedTime)}
                                    </div>
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="flex gap-3 mb-10">
                                <button
                                    onClick={toggleTimer}
                                    className="flex-1 bg-white/10 hover:bg-white/15 border border-white/20 text-white py-4 px-6 text-sm transition-all flex items-center justify-center gap-2 tracking-wider rounded-lg"
                                >
                                    {isRunning ? <><PauseIcon /> PAUSE</> : <><PlayIcon /> START</>}
                                </button>
                                
                                <button
                                    onClick={resetTimer}
                                    className="bg-white/5 hover:bg-white/10 border border-white/10 text-white py-4 px-6 transition-all rounded-lg"
                                >
                                    <RotateCcwIcon />
                                </button>
                            </div>

                            {/* Duration Input */}
                            <div>
                                <label className="text-xs text-gray-600 mb-3 block tracking-wider">
                                    DURATION
                                </label>
                                <div className="border border-white/10 bg-white/5 p-4 rounded-lg">
                                    <input
                                        type="number"
                                        min="1"
                                        value={workTime}
                                        onChange={(e) => {
                                            const newTime = parseInt(e.target.value) || 1;
                                            setWorkTime(newTime);
                                            if (!isRunning) setTimeLeft(newTime);
                                        }}
                                        className="w-full bg-transparent text-3xl font-light text-white focus:outline-none text-center"
                                        disabled={isRunning}
                                    />
                                </div>
                                <div className="text-center text-xs text-gray-700 mt-2 tracking-wider">
                                    SECONDS
                                </div>
                                <div className="text-center text-[10px] text-gray-800 mt-3 tracking-wider">
                                    üíæ Auto-guardado
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-6">
                            <div className="text-[10px] text-gray-800 tracking-[0.3em]">
                                LOOP v2.0
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<TechTimer />);
    </script>
</body>
</html>
